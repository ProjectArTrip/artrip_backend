  version: "3.8"

  services:
    app:
      container_name: backend
      build:
        context: .
        dockerfile: Dockerfile
      image: backend:develop
      ports:
        - ${HTTP_PORT:-880}:8080
      volumes:
        - ./src:/app/src
      depends_on:
        - db
        - redis
        - elasticsearch
        - kibana
      environment:
        - SPRING_PROFILE=dev

#    db:
#      image: mysql:8.4
#      container_name: db
#      platform: linux/amd64
#      environment:
#        MYSQL_USER: artrip
#        MYSQL_ROOT_PASSWORD: "artrip1!"
#        MYSQL_DATABASE: artrip
#        MYSQL_PASSWORD: artrip1!
#      ports:
#        - "33068:3306"
#      volumes:
#        - ./db/data:/var/lib/mysql
#        - ./db/conf:/etc/mysql/conf.d

    redis:
      image: redis:7.2
      container_name: redis
      restart: always
      ports:
        - "63799:6379"
      volumes:
        - redis-data:/data
      environment:
        - SPRING_PROFILES_ACTIVE=dev

    elasticsearch:
      image: elasticsearch:8.11.0
      container_name: elastic
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
        - xpack.security.http.ssl.enabled=false
        - ES_JAVA_OPTS=-Xms1g -Xmx1g
      ports:
        - "9200:9200"
        - "9300:9300"
      volumes:
        - ./elasticsearch/data:/usr/share/elasticsearch/data

    kibana:
      image: kibana:8.11.0
      container_name: kibana
      environment:
        - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        - ELASTICSEARCH_USERNAME=elasticsearch
        - SERVER_HOST=0.0.0.0
        - ELASTICSEARCH_PASSWORD=""
        - xpack.security.enabled=false
        - logging.level=debug
      ports:
        - "5601:5601"
      depends_on:
        - elasticsearch
      restart: always

  volumes:
    redis-data: