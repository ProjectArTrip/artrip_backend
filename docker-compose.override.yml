  version: "3.8"

  services:
    app:
      container_name: backend
      build:
        context: .
        dockerfile: Dockerfile
      image: backend:develop
      ports:
        - ${HTTP_PORT:-880}:8080
      volumes:
        - ./src:/app/src
      depends_on:
        - db
        - mongodb
        - elasticsearch
        - kibana
      environment:
        - SPRING_PROFILE=dev

    db:
      image: mysql:8.4
      container_name: db
      platform: linux/amd64
      environment:
        MYSQL_USER: ${DB_USER:-artrip}
        MYSQL_ROOT_PASSWORD: "artrip1!"
        MYSQL_DATABASE: ${DB:-artrip}
        MYSQL_PASSWORD: ${DB_PASSWORD:-artrip1!}
      ports:
        - ${DB_PORT:-33068}:3306
      volumes:
        - ./db/data:/var/lib/mysql
        - ./db/conf:/etc/mysql/conf.d

    mongodb:
      image: mongo:6.0
      container_name: mongodb
      restart: always
      ports:
        - "27017:27017"
      volumes:
        - ./mongodb/data:/data/db
      environment:
        - MONGO_INITDB_ROOT_USERNAME=root
        - MONGO_INITDB_ROOT_PASSWORD=artrip1!

    elasticsearch:
      image: elasticsearch:8.11.0
      container_name: elastic
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
        - xpack.security.enrollment.enabled=false
        - xpack.security.http.ssl.enabled=false
        - xpack.security.transport.ssl.enabled=false
        - ES_JAVA_OPTS=-Xms256m -Xmx256m  
        - bootstrap.memory_lock=true
      ports:
        - "9200:9200"
        - "9300:9300"
      volumes:
        - ./elasticsearch/data:/usr/share/elasticsearch/data
      ulimits:
        memlock:
          soft: -1
          hard: -1
        nofile:
          soft: 65536
          hard: 65536
      mem_limit: 1g
    
    kibana:
      image: kibana:8.11.0
      container_name: kibana
      environment:
        - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        - ELASTICSEARCH_USERNAME=elasticsearch
        - SERVER_HOST=0.0.0.0
        - ELASTICSEARCH_PASSWORD=""
        - xpack.security.enabled=false
        - logging.level=debug
      ports:
        - "5601:5601"
      depends_on:
        - elasticsearch
      restart: always